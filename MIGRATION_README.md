# Миграция для изоляции данных пользователей

Этот документ описывает процесс миграции для обеспечения изоляции данных между пользователями в приложении GymGuru.

## Что изменилось

### 1. Модели данных
- **Timeline**: добавлено поле `user` для связи с пользователем
- **KeyPhoto**: добавлено поле `user` для связи с пользователем
- Добавлены ограничения уникальности: `(user, name)` для Timeline и `(user, filename)` для KeyPhoto

### 2. Структура S3
- **Старая структура**: `keyphotos/{filename}`
- **Новая структура**: `users/{user_id}/{username}/keyphotos/{filename}`

### 3. Безопасность
- Все API endpoints теперь проверяют принадлежность данных текущему пользователю
- Пользователи могут видеть и изменять только свои данные

## Процесс миграции

### Шаг 1: Применение миграций базы данных

```bash
python manage.py migrate timelines
```

Это применит две миграции:
- `0010_add_user_fields.py` - добавляет поля user
- `0011_migrate_existing_data.py` - мигрирует существующие данные

### Шаг 2: Миграция файлов в S3

**Сначала выполните dry-run для проверки:**

```bash
python manage.py migrate_s3_files --dry-run
```

**Затем выполните реальную миграцию:**

```bash
python manage.py migrate_s3_files
```

### Шаг 3: Проверка результатов

После миграции проверьте:
1. Все Timeline и KeyPhoto имеют поле user
2. Файлы в S3 находятся в новых папках
3. API endpoints работают корректно

## Новые API endpoints

### Получение данных пользователя
- `GET /timelines/my-timelines/` - все timeline пользователя
- `GET /timelines/my-keyphotos/` - все keyphoto пользователя

### Существующие endpoints (теперь изолированы)
- `POST /timelines/new-timeline/` - создание timeline для текущего пользователя
- `POST /timelines/keyphoto/new/` - загрузка фото для текущего пользователя
- `GET/PUT/DELETE /timelines/keyphoto/{id}/` - работа с конкретным фото пользователя

## Структура папок в S3

```
testguru-v2/
├── users/
│   ├── 1/
│   │   └── username1/
│   │       └── keyphotos/
│   │           ├── photo1.jpg
│   │           └── photo2.png
│   └── 2/
│       └── username2/
│           └── keyphotos/
│               └── photo3.jpg
```

## Важные замечания

1. **Резервное копирование**: Перед миграцией обязательно создайте резервную копию базы данных и S3 bucket
2. **Тестирование**: Сначала протестируйте миграцию на тестовой среде
3. **Время простоя**: Миграция S3 файлов может занять время в зависимости от количества файлов
4. **Дефолтный пользователь**: Существующие данные будут привязаны к пользователю `default_user` с паролем `default_password_change_me`

## Откат изменений

В случае проблем можно откатить изменения:

```bash
# Откат миграций базы данных
python manage.py migrate timelines 0009

# Восстановление файлов в S3 (требует ручного вмешательства)
```

## Безопасность после миграции

После успешной миграции:
1. Измените пароль дефолтного пользователя
2. Убедитесь, что все API endpoints требуют аутентификации
3. Проверьте, что пользователи не могут получить доступ к чужим данным

## Поддержка

При возникновении проблем:
1. Проверьте логи Django
2. Проверьте логи AWS CloudWatch
3. Убедитесь, что у приложения есть необходимые права для работы с S3
